<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Dust to Dust</title>
</head>
<body>
  <script src="pixi.min.js"></script>
  <script type="text/javascript">
    let Container = PIXI.Container,
        autoDetectRenderer = PIXI.autoDetectRenderer,
        Sprite = PIXI.Sprite,
        loader = PIXI.loader,
        resources = PIXI.loader.resources
    
    let stage = new Container(),
        renderer = autoDetectRenderer(window.innerHeight - 16, window.innerHeight - 16);
    document.body.appendChild(renderer.view);

    renderer.view.style.border = "2px dashed black";
    renderer.backgroundColor = "0xFFFFFF";
    document.body.style.overflow = "hidden";
    document.body.style.backgroundColor = "white";

    loader
      .add("Odyssey.jpg")
      .load(setup);

    let sprite, state;
    
    function setup() {
      player = new Sprite(resources["Odyssey.jpg"].texture);
      sprite = new Sprite(resources["Odyssey.jpg"].texture);
      
      player.width = renderer.view.width / 5;
      player.height = renderer.view.height / 5;
      sprite.width = renderer.view.width * 1.5;
      sprite.height = renderer.view.height * 1.5;
      player.x = renderer.view.width / 2 - player.width / 2;
      player.y = renderer.view.height / 2 - player.height / 2;
      sprite.x = renderer.view.width / 2 - sprite.width / 2;
      sprite.y = renderer.view.height / 2 - sprite.height / 2;
      sprite.vx = 0;
      sprite.vy = 0;
      sprite.accelerationX = 0;
      sprite.accelerationY = 0;
      sprite.frictionX = 1;
      sprite.frictionY = 1;
      sprite.speed = 0.25;
      sprite.drag = 0.75;
      
      stage.addChild(sprite);
      stage.addChild(player);
      
      var left = keyboard(37),
          up = keyboard(38),
          right = keyboard(39),
          down = keyboard(40);

      left.press = () => {sprite.accelerationX = -sprite.speed; sprite.frictionX = 1;};
      left.release = () => {if (!right.isDown) {sprite.accelerationX = 0; sprite.frictionX = sprite.drag}};

      up.press = () => {sprite.accelerationY = -sprite.speed; sprite.frictionY = 1;};
      up.release = () => {if (!down.isDown) {sprite.accelerationY = 0; sprite.frictionY = sprite.drag}};

      right.press = () => {sprite.accelerationX = sprite.speed; sprite.frictionX = 1;};
      right.release = () => {if (!left.isDown) {sprite.accelerationX = 0; sprite.frictionX = sprite.drag}};

      down.press = () => {sprite.accelerationY = sprite.speed; sprite.frictionY = 1;};
      down.release = () => {if (!up.isDown) {sprite.accelerationY = 0; sprite.frictionY = sprite.drag}};
      
      state = play;
      
      gameLoop();
    }
    
    function gameLoop() {
      requestAnimationFrame(gameLoop);
      
      state();
      
      renderer.render(stage);
    }
    
    function contain(sprite2, container) {
      var collision = new Set();
      
      if (sprite2.x > container.x) {
        sprite2.x = container.x;
        collision.add("right");}
      if (sprite2.y > container.y) {
        sprite2.y = container.y;
        collision.add("bottom");}
      if (sprite2.x + sprite2.width < container.width + container.x) {
        sprite2.x = container.width - sprite2.width + container.x;
        collision.add("left");}
      if (sprite2.y + sprite2.height < container.height + container.y) {
        sprite2.y = container.height - sprite2.height + container.y;
        collision.add("top");}
      
      if (collision.size === 0) collision = undefined;
      
      return collision;
    }
    
    function play() {
      sprite.vy += sprite.accelerationY
      sprite.vx += sprite.accelerationX
      
      sprite.vx *= sprite.frictionX
      sprite.vy *= sprite.frictionY
      
      if (sprite.vx > 5) {sprite.vx = 5} else if (sprite.vx < -5) {sprite.vx = -5};
      if (sprite.vy > 5) {sprite.vy = 5} else if (sprite.vy < -5) {sprite.vy = -5};
      
      sprite.x -= sprite.vx
      sprite.y -= sprite.vy
      
      let collision = contain(sprite, {x:player.x, y:player.y, width: player.width, height: player.height});
      
      if (collision) {
        if(collision.has("left") || collision.has("right")) {sprite.vx = 0}
        if(collision.has("top") || collision.has("bottom")) {sprite.vy = 0}
      }
    }
    
    function keyboard(keyCode) {
      var key = {};
      key.code = keyCode;
      key.isDown = false;
      key.isUp = true;
      key.press = undefined;
      key.release = undefined;

      key.downHandler = function(event) {
        if (event.keyCode === key.code) {
          if (key.isUp && key.press) key.press(); 
          key.isDown = true;
          key.isUp = false;
        } 
        event.preventDefault();};
      key.upHandler = function(event) {
        if (event.keyCode === key.code) {
          if (key.isDown && key.release) key.release();
          key.isDown = false;
          key.isUp = true;
        }
        event.preventDefault();};

      window.addEventListener("keydown", key.downHandler.bind(key), false);
      window.addEventListener("keyup", key.upHandler.bind(key), false);

      return key;
    }
  </script>
</body>
</html>
