<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Dust to Dust</title>
</head>
<body>
  <script src="pixi.min.js"></script>
  <script type="text/javascript">
    let Container = PIXI.Container, autoDetectRenderer = PIXI.autoDetectRenderer, Sprite = PIXI.Sprite, loader = PIXI.loader, resources = PIXI.loader.resources
    
    let stage = new Container(),
        renderer = autoDetectRenderer(window.innerHeight - 16, window.innerHeight - 16);
    document.body.appendChild(renderer.view);

    renderer.view.style.border = "2px dashed black";
    renderer.backgroundColor = "0xFFFFFF";
    document.body.style.overflow = "hidden";
    document.body.style.backgroundColor = "white";

    loader
      .add("Odyssey.jpg")
      .load(setup);

    let sprite, state;
    
    function setup() {
      sprite = new Sprite(resources["Odyssey.jpg"].texture);
      
      sprite.x = renderer.view.width / 2;
      sprite.y = renderer.view.width / 2;
      sprite.width = window.innerHeight / 5;
      sprite.height = window.innerHeight / 5;
      sprite.vx = 0;
      sprite.vy = 0;
      sprite.accelerationX = 0;
      sprite.accelerationY = 0;
      sprite.frictionX = 1;
      sprite.frictionY = 1;
      sprite.speed = 0.2;
      sprite.drag = 0.98;
      
      stage.addChild(sprite);
      
      var left = keyboard(37), up = keyboard(38), right = keyboard(39), down = keyboard(40);

      left.press = () => {sprite.accelerationX = -sprite.speed; sprite.frictionX = 1;};
      left.release = () => {if (!right.isDown && sprite.vy === 0) {sprite.accelerationX = 0; sprite.frictionX = sprite.drag}};

      up.press = () => {sprite.accelerationY = -sprite.speed; sprite.frictionY = 1;};
      up.release = () => {if (!down.isDown && sprite.vx === 0) {sprite.accelerationY = 0; sprite.frictionY = sprite.drag}};

      right.press = () => {sprite.accelerationX = sprite.speed; sprite.frictionX = 1;};
      right.release = () => {if (!left.isDown && sprite.vy === 0) {sprite.accelerationX = 0; sprite.frictionX = sprite.drag}};

      down.press = () => {sprite.accelerationY = sprite.speed; sprite.frictionY = 1;};
      down.release = () => {if (!up.isDown && sprite.vx === 0) {sprite.accelerationY = 0; sprite.frictionY = sprite.drag}};
      
      state = play;
      
      gameLoop();
    }
    
    function gameLoop() {
      requestAnimationFrame(gameLoop);
      
      state();
      
      renderer.render(stage);
    }
    
    function play() {
      sprite.vy += sprite.accelerationY
      sprite.vx += sprite.accelerationX
      
      sprite.vx *= sprite.frictionX
      sprite.vy *= sprite.frictionY
      
      sprite.x += sprite.vx
      sprite.y += sprite.vy
      
      let collision = contain(sprite, {x:0, y:0, width: renderer.view.width, height: renderer.view.height});
      
      if (collision) {
        if(collision.has("left") || collision.has("right")) {sprite.vx = -sprite.vx}
        if(collision.has("top") || collision.has("bottom")) {sprite.vy = -sprite.vy}
      }
    }
    
    function keyboard(keyCode) {
      var key = {};
      key.code = keyCode;
      key.isDown = false;
      key.isUp = true;
      key.press = undefined;
      key.release = undefined;

      key.downHandler = function(event) {
        if (event.keyCode === key.code) {if (key.isUp && key.press) key.press(); key.isDown = true; key.isUp = false;}
        event.preventDefault();
      };

      key.upHandler = function(event) {
        if (event.keyCode === key.code) {if (key.isDown && key.release) key.release(); key.isDown = false; key.isUp = true;}
        event.preventDefault();
      };

      window.addEventListener("keydown", key.downHandler.bind(key), false);
      window.addEventListener("keyup", key.upHandler.bind(key), false);

      return key;
    }
    
    function contain {
      var collision = new Set();
      
      if (sprite.x < container.x) {sprite.x = container.x; container.add("left");}
      if (sprite.y < container.y) {sprite.y = container.y; container.add("top");}
      if (sprite.x + sprite.width > container.width) {sprite.x = container.width - sprite.width; container.add("right");}
      if (sprite.y + sprite.height > container.height) {sprite.y = container.height - sprite.height; container.add("bottom");}
      
      if (collision.size === 0) collision = undefined;
      
      return collision;
    }
  </script>
</body>
</html>
